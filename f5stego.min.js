/*! f5stego-js v0.1.0 | MIT license | https://github.com/desudesutalk/f5stegojs#readme */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.a=b()}(this,function(){"use strict";function a(a,b,c){return new ArrayBuffer(a,b,c)}function b(a,b,c){return new Uint8Array(a,b,c)}function c(a,b,c){return new Uint32Array(a,b,c)}function d(a,b,c){return new Uint16Array(a,b,c)}function e(a,b,c){return new Int16Array(a,b,c)}function f(a){return new Array(a)}function g(a){var b=a<<0;return b==a?b:b+1}function h(){for(var a=1,b=2,c=1;c<=15;c++){for(var d=a;d<b;d++)k[32767+d]=c,j[32767+d]=[],j[32767+d][1]=c,j[32767+d][0]=d;for(var e=-(b-1);e<=-a;e++)k[32767+e]=c,j[32767+e]=[],j[32767+e][1]=c,j[32767+e][0]=b-1+e;a<<=1,b<<=1}}function i(a,b){for(var c=0,d=0,e=[],f=1;f<=16;f++){for(var g=1;g<=a[f];g++)e[b[d]]=[],e[b[d]][0]=c,e[b[d]][1]=f,d++,c++;c*=2}return e}var f5stego=function(a,b){this.b=b||16777216,this.c(a)};f5stego.prototype.c=function(d){if(this.d=a(4.125*this.b),this.e=c(this.d),!d.length)throw"key needed";var e=0,f=0,g=0,h=0,i=b(256),j=b(this.d);for(e=0;e<256;++e)i[e]=e;for(e=0;e<256;++e)f=f+i[e]+d[e%d.length]&255,g=i[e],i[e]=i[f],i[f]=g;for(e=0,f=0,h=0;h<4.125*this.b;++h)e=e+1&255,f=f+i[e]&255,g=i[e],i[e]=i[f],i[f]=g,j[h]=i[g+i[e]&255]},f5stego.prototype.f=function(a){var d,e,f,g;if("number"==typeof a)for(e=a,a=c(e),f=1;f<e;f++)g=this.e[f]%(f+1),g!=f&&(a[f]=a[g]),a[g]=f;else for(e=a.length,f=1;f<e;f++)g=this.e[f]%(f+1),g!=f&&(d=a[f],a[f]=a[g],a[g]=d);return{g:a,h:b(this.d,4*e)}},f5stego.prototype.i=function(a){var b,c,d,e,f,g,h,i,j=0,k=0;for(e=0;e<a.length;e++)e%64!==0&&(0===a[e]&&k++,1!=a[e]&&a[e]!=-1||j++);b=a.length-k-j-a.length/64,c=j/(b+j);var l={capacity:[0,(b+.49*j>>3)-1],coeff_total:a.length,coeff_large:b,coeff_zero:k,coeff_one:j,coeff_one_ratio:j/(b+j)};for(e=2;e<17;e++){for(f=(1<<e)-1,d=b+j,g=0;d>f;)h=d/f/(1<<e)/(1<<e)|0,d-=h*f,i=d*(1-c)/f*.96|0,d-=i*f,g+=i+h,f++;l.capacity[e]=(e*g>>3)-1}return l},f5stego.prototype.j=function(a,b,c){var d,e,f,g=a.length,h=0,i=0,j=0,k=0,l=0,m=this.f(g),n=m.h,o=0;m=m.g;var p=0,q=b.length,r=0,s=0;for(e=(1<<c)-1,q=c-1,q^=n[o++],p=1&q,q>>=1,s=3,f=0;f<g;f++)if(l=m[f],l%64!==0&&0!==a[l]){var t=a[l];if(j++,t>0&&(1&t)!=p?(a[l]--,h++):t<0&&(1&t)==p&&(a[l]++,h++),0!==a[l]){if(i++,0===s){if(1!=c||r>=b.length)break;q=b[r++],q^=n[o++],s=8}p=1&q,q>>=1,s--}else k++}if(1==c&&i<8*b.length)throw"capacity exceeded "+i/8+" "+b.length;if(1!=c)for(var u=!1,v=0;!u||0!==s&&u;){for(v=0,d=0;d<c;d++){if(0===s){if(r>=b.length){u=!0;break}q=b[r++],q^=n[o++],s=8}p=1&q,q>>=1,s--,v|=p<<d}var w=[],x=null;for(d=0;d<e;d++){for(;;){if(++f>=g)throw"capacity exceeded "+i/8;if(x=m[f],x%64!==0&&0!==a[x])break}w.push(x)}for(j+=e;;){var y,z=0;for(d=0;d<w.length;d++)y=a[w[d]]>0?1&a[w[d]]:1-(1&a[w[d]]),1==y&&(z^=d+1);if(d=z^v,!d){i+=c;break}if(d--,a[w[d]]+=a[w[d]]<0?1:-1,h++,0!==a[w[d]]){i+=c;break}for(k++,w.splice(d,1);;){if(++f>=g)throw"capacity exceeded "+i/8;if(x=m[f],x%64!==0&&0!==a[x])break}j++,w.push(x)}}return{k:c,embedded:i/8,examined:j,changed:h,thrown:k,efficiency:(i/h).toFixed(2)}},f5stego.prototype.analyze=function(){var a,b=this.m.l[0];if(1!=b.n)for(a=0;a<this.m.l.length;a++)if(1==this.m.l[a].n){b=this.m.l[a];break}return this.i(b.o)},f5stego.prototype.f5put=function(a,c){var d,e,f=this.m.l[0];if(a.length>8388607)throw"Data too big. Max 8388607 bytes allowed.";if(a.length<32768?(d=b(2+a.length),d[0]=255&a.length,d[1]=a.length>>>8,d.set(a,2)):(d=b(3+a.length),d[0]=255&a.length,d[1]=(a.length>>>8&127)+128,d[2]=a.length>>>15,d.set(a,3)),1!=f.n)for(e=0;e<this.m.l.length;e++)if(1==this.m.l[e].n){f=this.m.l[e];break}if(c)return this.j(f.o,d,c);var g,h=this.i(f.o);for(c=0,e=h.capacity.length-1;e>=0;e--)if(h.capacity[e]>=d.length){c=e;break}if(0===c)throw"capacity exceeded";try{g=this.j(f.o,d,c)}catch(a){if(c--,0===c)throw"capacity exceeded";g=this.j(f.o,d,c)}return g.stats=h,g},f5stego.prototype.f5get=function(){var a=this.m.l[0];if(1!=a.n)for(var c=0;c<this.m.l.length;c++)if(1==this.m.l[c].n){a=this.m.l[c];break}var d=e(a.o.length);d.set(a.o);for(var f,g=-1,h=0,i=d.length-1,j=this.f(d),k=j.h,l=0,m=0,n=b(d.length/8|0),o=0,p=0,q=0,r=0,s=0;q<4;)g++,0!==d[g]&&(h=1&d[g],d[g]<0&&(h=1-h),m|=h<<q,q++);if(m=(m^15&k[l++])+1,f=(1<<m)-1,q=0,1==m)for(;g<i;)g++,0!==d[g]&&(h=1&d[g],d[g]<0&&(h=1-h),o|=h<<q,q++,8==q&&(n[p++]=o^k[l++],o=0,q=0));else for(;g<i;)if(g++,0!==d[g]&&(h=1&d[g],d[g]<0&&(h=1-h),s^=h*++r,r==f))for(o|=s<<q,q+=m,r=0,s=0;q>=8;)n[p++]=255&o^k[l++],q-=8,o>>=8;for(;q>0;)n[p++]=255&o^k[l++],q-=8,o>>=8;var t=2,u=n[0];return 128&n[1]?(t++,u+=((127&n[1])<<8)+(n[2]<<15)):u+=n[1]<<8,n.subarray(t,t+u)},f5stego.prototype.parse=function(a){function c(a,b){for(var c=0,e=0,f=d(65536),g=0;g<16;g++){for(var h=0;h<a[g];h++){for(var i=c<<15-g,j=c+1<<15-g;i<j;i++)f[i]=b[e]+(g+1<<8);e++,c++}c*=2}return f}function f(a,b,c,d,e,f,g,h,i){function j(c,d){for(;r<16;)q=(q<<8)+(0|a[b]),r+=8,255==a[b]&&b++,b++;var e=c.p[q>>>r-16&65535];if(!e)throw"invalid huffman sequence";r-=e>>>8,e&=255;var f=0;if(0!==e){for(;r<e;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;f=q>>>r-e&(1<<e)-1,r-=e,f<1<<e-1&&(f+=(-1<<e)+1)}c.q[d>>6]=c.r+=f;for(var g,h,i=1;i<64;){for(;r<16;)q=(q<<8)+(0|a[b]),r+=8,255==a[b]&&b++,b++;if(g=c.s[q>>>r-16&65535],!g)throw"invalid huffman sequence";if(r-=g>>>8,h=g>>4&15,g&=15,0!==g){for(i+=h;r<g;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;c.o[d+i]=q>>>r-g&(1<<g)-1,r-=g,c.o[d+i]<1<<g-1&&(c.o[d+i]+=(-1<<g)+1),i++}else{if(h<15)break;i+=16}}}function k(c,d){for(var e=0;r<16;)q=(q<<8)+(0|a[b]),r+=8,255==a[b]&&b++,b++;var f=c.p[q>>>r-16&65535];if(!f)throw"invalid huffman sequence";if(r-=f>>>8,f&=255,0!==f){for(;r<f;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;e=q>>>r-f&(1<<f)-1,r-=f,e<1<<f-1&&(e+=(-1<<f)+1)}c.q[d>>6]=c.r+=e<<i}function l(c,d){r||(q=a[b++],255==q&&b++,r=8),c.q[d>>6]|=(q>>>--r&1)<<i}function m(c,d){if(s>0)return void s--;for(var e,h,i=f;i<=g;){for(;r<16;)q=(q<<8)+(0|a[b]),r+=8,255==a[b]&&b++,b++;if(e=c.s[q>>>r-16&65535],!e)throw"invalid huffman sequence";if(r-=e>>>8,h=e>>4&15,e&=15,0!==e){for(i+=h;r<e;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;c.o[d+i]=q>>>r-e&(1<<e)-1,r-=e,c.o[d+i]<1<<e-1&&(c.o[d+i]+=(-1<<e)+1),c.o[d+i]*=t,i++}else{if(15!=h){if(s=(1<<h)-1,h){for(;r<h;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;s+=q>>>r-h&(1<<h)-1,r-=h}break}i+=16}}}function n(c,d){var e,h,i=f;if(!s)for(;i<=g;){for(;r<16;)q=(q<<8)+(0|a[b]),r+=8,255==a[b]&&b++,b++;if(h=c.s[q>>>r-16&65535],!h)throw"invalid huffman sequence";if(r-=h>>>8,e=h>>4&15,h&=15){if(1!=h)throw"bad jpeg";r||(q=a[b++],255==q&&b++,r=8),h=q>>>--r&1?t:u}else if(15!=e){if(s=1<<e,e){for(;r<e;)q=(q<<8)+a[b++],255==(255&q)&&b++,r+=8;s+=q>>>r-e&(1<<e)-1,r-=e}break}for(;i<=g;){if(c.o[d+i])r||(q=a[b++],255==q&&b++,r=8),c.o[d+i]+=(q>>>--r&1)*(c.o[d+i]>=0?t:u);else if(--e<0)break;i++}h&&(c.o[d+i]=h),i++}if(s){for(;i<=g;)c.o[d+i]&&(r||(q=a[b++],255==q&&b++,r=8),c.o[d+i]+=(q>>>--r&1)*(c.o[d+i]>=0?t:u)),i++;s--}}var o,p=b,q=0,r=0,s=0,t=1<<i,u=-1<<i;o=c.t?0===f?0===h?k:l:0===h?m:n:j;var v,w,x,y,z,A,B,C,D,E;if(1==d.length)for(B=d[0].u,C=d[0].v,w=C*B,e||(e=w),A=e,d[0].r=0,s=0,E=0;E<C;E++)for(D=0;D<B;D++){if(!A){if(A=e,d[0].r=0,s=0,b-=r/8|0,255==a[b-1]&&b--,r=0,v=a[b]<<8|a[b+1],!(v>=65488&&v<=65495)){if(v<=65280)throw"bad jpeg";break}b+=2}for(A--,x=0;x<d.length;x++)o(d[x],64*(E*d[x].w+D))}else{for(B=c.x,C=c.y,w=C*B,e||(e=w),A=e,x=0;x<d.length;x++)d[x].r=0;for(s=0,E=0;E<C;E++)for(D=0;D<B;D++){if(!A){for(A=e,x=0;x<d.length;x++)d[x].r=0;if(s=0,b-=r/8|0,255==a[b-1]&&b--,r=0,v=a[b]<<8|a[b+1],!(v>=65488&&v<=65495)){if(v<=65280)throw"bad jpeg";break}b+=2}for(A--,x=0;x<d.length;x++)for(y=0;y<d[x].z;y++)for(z=0;z<d[x].A;z++)o(d[x],64*((E*d[x].z+y)*d[x].w+D*d[x].A+z))}}return b-=r/8|0,255==a[b-1]&&b--,b-p}function h(){var b=a[j]<<8|a[j+1];return j+=2,b}function i(){var b=h(),c=a.subarray(j,j+b-2);return j+=c.length,c}var j=0;this.B=a,this.C=null,this.D=[],this.E=[],this.m=null,this.F=null;for(var k,l,m,n,o,p,q=[],r=[];;){if(j>=a.length)throw"unexpected EOF";if(k=a[j++],l=a[j++],255==k){if(224==l&&(this.C=i()),(l>224&&l<240||254==l)&&this.D.push({app:l,data:i()}),219==l&&this.E.push(i()),l>=192&&l<=194){if(this.m)throw"Only single frame JPEGs supported";if(h(),this.m={G:193===l,t:194===l,H:a[j++],I:h(),J:h(),l:[],K:{},L:1,M:1},this.m.I*this.m.J>this.b)throw"Image is too big.";var s,t=a[j++],u=0,v=0;for(m=0;m<t;m++){s=a[j];var w=a[j+1]>>4,x=15&a[j+1];u<w&&(u=w),v<x&&(v=x);var y=a[j+2],z=this.m.l.push({n:s,A:w,z:x,N:y});this.m.K[s]=z-1,j+=3}this.m.L=u,this.m.M=v;var A=g(this.m.J/8/u),B=g(this.m.I/8/v);for(m=0;m<this.m.l.length;m++){p=this.m.l[m];var C=g(g(this.m.J/8)*p.A/u),D=g(g(this.m.I/8)*p.z/v),E=A*p.A,F=B*p.z;p.o=e(F*E*64),p.q=e(F*E),p.u=C,p.v=D,p.w=E,p.O=F}this.m.x=A,this.m.y=B}if(196==l){var G=h();for(m=2;m<G;){var H=a[j++],I=b(16),J=0;for(n=0;n<16;n++,j++)J+=I[n]=a[j];var K=b(J);for(n=0;n<J;n++,j++)K[n]=a[j];m+=17+J,(H>>4===0?r:q)[15&H]=c(I,K)}}if(221==l&&(o=h()),218==l){h();var L=a[j++],M=[];for(m=0;m<L;m++){var N=this.m.K[a[j++]];p=this.m.l[N];var O=a[j++];p.p=r[O>>4],p.s=q[15&O],M.push(p)}var P=a[j++],Q=a[j++],R=a[j++],S=f(a,j,this.m,M,o,P,Q,R>>4,15&R);j+=S}if(217==l)break}else{for(255==a[j-3]&&a[j-2]>=192&&a[j-2]<=254&&(j-=3);255!=a[j]&&j<a.length;)j++;if(255!=a[j])throw"bad jpeg "}}if(!this.m)throw"bad jpeg";return j<a.length&&(this.F=a.subarray(j)),this};var j=f(65535),k=f(65535),l=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],m=[0,1,2,3,4,5,6,7,8,9,10,11],n=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],o=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],p=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],q=[0,1,2,3,4,5,6,7,8,9,10,11],r=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],s=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];h();var t=i(l,m),u=i(p,q),v=i(n,o),w=i(r,s);return f5stego.prototype.pack=function(){function a(a){var c;z[D++]=a,D>C&&(c=b(2*z.length),c.set(z),z=c,C=c.length-128)}function c(b){a(b>>8&255),a(255&b)}function d(a){var c;D+a.length>C&&(c=b(2*z.length+a.length),c.set(z),z=c,C=c.length-128),z.set(a,D),D+=a.length}function e(b){c(65504),b.C?(c(b.C.length+2),d(b.C)):(c(16),a(74),a(70),a(73),a(70),a(0),a(1),a(1),a(0),c(1),c(1),a(0),a(0))}function f(a){for(var b=0;b<a.E.length;b++)c(65499),c(a.E[b].length+2),d(a.E[b])}function g(a){for(var b=0;b<a.D.length;b++)c(65280|a.D[b].app),c(a.D[b].data.length+2),d(a.D[b].data)}function h(b){c(65472),c(8+3*b.m.l.length),a(b.m.H),c(b.m.I),c(b.m.J),a(b.m.l.length);for(var d=0;d<b.m.l.length;d++){var e=b.m.l[d];a(e.n),a(e.A<<4|e.z),a(e.N)}}function i(b){c(65476),c(31),a(0);for(var d=0;d<16;d++)a(l[d+1]);for(var e=0;e<=11;e++)a(m[e]);c(65476),c(181),a(16);for(var f=0;f<16;f++)a(n[f+1]);for(var g=0;g<=161;g++)a(o[g]);if(1!=b.m.l.length){c(65476),c(31),a(1);for(var h=0;h<16;h++)a(p[h+1]);for(var i=0;i<=11;i++)a(q[i]);c(65476),c(181),a(17);for(var j=0;j<16;j++)a(r[j+1]);for(var k=0;k<=161;k++)a(s[k])}}function x(b){c(65498),c(6+2*b.m.l.length),a(b.m.l.length);for(var d=0;d<b.m.l.length;d++){var e=b.m.l[d];a(e.n),a(0===d?0:17)}a(0),a(63),a(0)}function y(a,c,d,e,f){var g,h,i;0===B&&(A=0);var l=a.q[c>>6]-d;if(d=a.q[c>>6],0===l)for(h=e[0][1],A<<=h,A+=e[0][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;else for(g=32767+l,h=e[k[g]][1],A<<=h,A+=e[k[g]][0],B+=h,h=j[g][1],A<<=h,A+=j[g][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;for(var m=63;m>0&&0===a.o[c+m];m--);if(0===m){for(h=f[0][1],A<<=h,A+=f[0][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;return d}for(var n,o=1;o<=m;){for(var p=o;0===a.o[c+o]&&o<=m;++o);var q=o-p;if(q>=16){n=q>>4;for(var r=1;r<=n;++r)for(h=f[240][1],A<<=h,A+=f[240][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;q=15&q}for(g=32767+a.o[c+o],h=f[(q<<4)+k[g]][1],A<<=h,A+=f[(q<<4)+k[g]][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;for(h=j[g][1],A<<=h,A+=j[g][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;o++}if(63!=m)for(h=f[0][1],A<<=h,A+=f[0][0],B+=h;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8,A&=(1<<B)-1;return D>C&&(i=b(2*z.length),i.set(z),z=i,C=i.length-128),d}var z,A,B,C,D,E;z=b(65536),C=65408,D=0,A=0,B=0,c(65496),e(this),g(this),f(this),h(this),i(this),x(this),A=0,B=0;var F,G,H,I,J,K,L,M,N,O=[];for(L=0;L<this.m.l.length;L++)O.push(0);for(K=0;K<this.m.x*this.m.y;K++)for(G=K/this.m.x|0,H=K%this.m.x,L=0;L<this.m.l.length;L++)for(F=this.m.l[L],M=0;M<F.z;M++)for(I=G*F.z+M,N=0;N<F.A;N++)J=H*F.A+N,0===L?O[L]=y(F,64*(I*this.m.x*F.A+J),O[L],t,v):O[L]=y(F,64*(I*this.m.x*F.A+J),O[L],u,w);for(;B>7;)E=255&A>>>B-8,z[D++]=E,255==E&&D++,B-=8;return B>0&&(A<<=8-B,A+=(1<<8-B)-1,z[D++]=255&A),c(65497),this.F&&d(this.F),z.slice(0,D)},f5stego.prototype.clearTail=function(){if(!this.F)return null;var a=this.F;return this.F=null,a},f5stego.prototype.P=function(a){this.F=a},f5stego.prototype.getTail=function(){return this.F},f5stego.prototype.clearAPPs=function(){var a=this.D;return this.D=[],a},f5stego.prototype.getAPPn=function(a,c){var d,e,f=b(0),g=[];if(a&=255,a<16&&(a+=224),224===a)return this.C;for(d=0;d<this.D.length;d++)this.D[d].app==a?(e=b(f.length+this.D[d].data.length),e.set(f),e.set(this.D[d].data,f.length),f=e):c&&g.push(this.D[d]);return c&&(this.D=g),0===f.length?null:f},f5stego.prototype.setAPPn=function(a,b){var c,d,e;if(a&=255,a<16&&(a+=224),224===a)return d=this.C,this.C=b,d;if(e=this.getAPPn(a,!0),b.length<65534)return this.D.push({app:a,data:b}),e;for(c=0;c<b.length;)this.D.push({app:a,data:b.subarray(c,c+65533)}),c+=65533;return e},f5stego.prototype.strip=function(){return this.clearTail(),this.clearAPPs(),!0},f5stego.prototype.embed=function(a,b){return this.parse(a).f5put(b),this.pack()},f5stego.prototype.extract=function(a){return this.parse(a).f5get()},f5stego});